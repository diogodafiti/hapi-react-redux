{"version":3,"sources":["../src/plugin/index.js"],"names":["hapiReactReduxPlugin","server","options","next","decorate","assert","realm","plugins","hapiReactRedux","settings","context","routes","Layout","layout","assets","config","createStore","pre","request","auth","store","iso","location","raw","req","url","err","redirect","props","response","pathname","search","code","reduxStore","then","rootHtml","e","add","preloadedState","getState","render","notFound","handler","route","reply","hapiReactReduxRender","attributes","name","module","exports","register"],"mappings":"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","file":"index.js","sourcesContent":["import React from 'react'\nimport { renderToString } from 'react-dom/server'\nimport { match, RouterContext } from 'react-router'\nimport Iso from 'iso'\nimport Hoek from 'hoek'\nimport routeResovler from 'route-resolver'\nimport Boom from 'boom'\nimport UniversalProvider from './universal-provider'\n\nfunction hapiReactReduxPlugin(server, options, next) {\n\n  server.decorate('server', 'hapiReactRedux', function(options) {\n\n    Hoek.assert(options, 'Missing options')\n    this.realm.plugins.hapiReactRedux = this.realm.plugins.hapiReactRedux || {}\n    Hoek.assert(!this.realm.plugins.hapiReactRedux.settings, 'Cannot set hapiReactRedux settings more than once')\n    this.realm.plugins.hapiReactRedux.settings = options\n\n  })\n\n  server.decorate('reply', 'hapiReactReduxRender', function(context) {\n\n    const realm = this.realm.plugins.hapiReactRedux\n    Hoek.assert(realm.settings, 'Cannot render app without settings')\n\n    const routes = realm.settings.routes\n    const Layout = realm.settings.layout\n    const assets = realm.settings.assets\n    const config = realm.settings.config\n    // TODO: where does this go now?\n    const createStore = realm.settings.createStore\n    // any extra data\n    const pre = this.request.pre\n    // is there a user?\n    const auth = this.request.auth\n    const store = createStore({ auth })\n\n\n    const iso = new Iso()\n\n    match({ routes, location: this.request.raw.req.url }, (err, redirect, props) => {\n      if (err) {\n        return this.response(err)\n      } else if (redirect) {\n        this.redirect(redirect.pathname + redirect.search).code(301)\n      } else if (props) {\n        props.reduxStore = store\n        routeResovler(props, false, { store })\n          .then(() => {\n            let rootHtml = null\n            let layout = null\n            try {\n              rootHtml = renderToString(\n                <UniversalProvider pre={pre} serverContext={context} config={config} store={store}>\n                  <RouterContext {...props} />\n                </UniversalProvider>\n              )\n            } catch (e) {\n              if (e) return this.response(e)\n            }\n            iso.add(rootHtml, {\n              preloadedState: store.getState(),\n              pre,\n              context,\n              config,\n            })\n            try {\n              layout = renderToString(<Layout assets={assets} config={config} content={iso.render()} />)\n            } catch (e) {\n              if (e) return this.response(e)\n            }\n            this.response(`<!doctype html>\\n${layout}`)\n          })\n      } else {\n      // no errors, no redirect, we just didn't match anything\n        this.response(Boom.notFound(`Unable to find maching route for ${this.request.raw.req.url}`))\n      }\n    })\n\n  })\n\n\n  server.handler('hapiReactReduxHandler', function(route, options) {\n    return function(request, reply) {\n      reply.hapiReactReduxRender()\n    }\n  })\n\n  next()\n}\n\nhapiReactReduxPlugin.attributes = {\n  name: 'hapi-react-redux'\n}\n\nmodule.exports = {\n  register: hapiReactReduxPlugin\n}\n"]}